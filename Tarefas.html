<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Studfy - Tarefas</title>
  <link rel="stylesheet" href="styleT.css" />
  <style>
    #toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background-color: #0d6efd;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transition: opacity 0.5s ease;
      z-index: 999;
    }

    #toast.show {
      opacity: 1;
    }

    .btn-excluir {
      align-self: flex-end;
      margin-top: 10px;
      color: #dc3545;
      cursor: pointer;
      font-size: 14px;
      background: none;
      border: none;
    }

    .btn-excluir:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

  <h2 id="tituloMateria"></h2>

  <form id="formTarefa">
    <input type="text" id="tituloTarefa" placeholder="Título da tarefa" required />
    <textarea id="descricaoTarefa" placeholder="Descrição da tarefa"></textarea>
    <input type="date" id="dataEntrega" required />
    <input type="number" id="notaTarefa" placeholder="Nota" step="0.1" />
    <label>
      <input type="checkbox" id="notificar" />
      Deseja receber notificação próxima da entrega?
    </label>
    <button type="submit">Adicionar Tarefa</button>
  </form>

  <ul id="listaTarefas"></ul>

  <div id="toast"></div>

  <script src="script.js"></script>
  <script>
    function mostrarToast(mensagem) {
      const toast = document.getElementById("toast");
      toast.textContent = mensagem;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 4000);
    }

    function carregarTarefas() {
      const rotina_id = localStorage.getItem("rotinaId");

      fetch(`http://localhost:3000/tarefas?rotina_id=${rotina_id}`)
        .then(res => res.json())
        .then(tarefas => {
          const lista = document.getElementById("listaTarefas");
          lista.innerHTML = "";

          const hoje = new Date();

          tarefas.forEach(tarefa => {
            const dataEntrega = new Date(tarefa.data_entrega);
            const diasRestantes = Math.ceil((dataEntrega - hoje) / (1000 * 60 * 60 * 24));

            if (tarefa.notificar && diasRestantes >= 0 && diasRestantes <= 2) {
              mostrarToast(`Entrega próxima: ${tarefa.titulo} em ${diasRestantes} dia(s)`);
            }

            const li = document.createElement("li");
            li.innerHTML = `
              <div class="linha-topo">
                <span class="titulo">${tarefa.titulo}</span>
              </div>
              <div class="descricao">${tarefa.descricao}</div>
              <div class="detalhes">Entrega: ${tarefa.data_entrega || 'Sem data'} | Nota: ${tarefa.nota || '-'}</div>
              <div class="detalhes">Notificar: ${tarefa.notificar ? 'Sim' : 'Não'}</div>
              <button class="btn-excluir" onclick="excluirTarefa(${tarefa.id})">Excluir</button>
            `;
            lista.appendChild(li);
          });
        })
        .catch(err => console.error("Erro ao carregar tarefas:", err));
    }

    function excluirTarefa(id) {
      if (!confirm("Deseja mesmo excluir esta tarefa?")) return;

      fetch(`http://localhost:3000/tarefa/${id}`, {
        method: "DELETE"
      })
      .then(res => res.json())
      .then(data => {
        mostrarToast("Tarefa excluída.");
        carregarTarefas();
      })
      .catch(err => console.error("Erro ao excluir tarefa:", err));
    }

    // Exibe nome da matéria no topo
    const nomeMateria = localStorage.getItem("nomeMateria");
    if (nomeMateria && document.getElementById("tituloMateria")) {
      document.getElementById("tituloMateria").textContent = `Tarefas de ${nomeMateria}`;
    }

    // Inicia funções ao abrir
    if (document.getElementById("formTarefa")) {
      carregarTarefas();
    }

    document.addEventListener("DOMContentLoaded", () => {
    adicionarTarefa();
    carregarTarefas(); // também garante que a lista carregue corretamente
});
  </script>
</body>
</html>
